<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeloShop - Debug</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div id="app">
        <header class="header">
            <div class="container">
                <router-link to="/" class="logo">üõçÔ∏è MeloShop</router-link>
                <nav class="nav">
                    <router-link to="/">Accueil</router-link>
                    <router-link to="/products">Produits</router-link>
                    <router-link to="/cart" class="cart-link">
                        üõí Panier
                        <span v-if="$store.getters.cartItemsCount > 0" class="badge">
                            {{ $store.getters.cartItemsCount }}
                        </span>
                    </router-link>
                </nav>
            </div>
        </header>

        <main class="main">
            <div v-if="notification" class="notification" :class="'notification-' + notification.type">
                {{ notification.message }}
            </div>

            <transition name="fade">
                <router-view></router-view>
            </transition>
        </main>

        <footer class="footer">
            <div class="container">
                <p>&copy; 2024 MeloShop - Powered by MelodiJS</p>
            </div>
        </footer>
    </div>

    <script type="module">
        import { createApp } from '../../dist/melodijs.js';
        import { MelodiRouter } from '../../dist/router.js';
        import { MelodiStore } from '../../dist/store.js';
        import { products, categories } from './products.js';

        console.log('üöÄ Initializing shop...');

        const store = new MelodiStore({
            state: () => ({ cart: [], products: products }),
            actions: {
                addToCart(product) {
                    console.log('‚ûï Adding to cart:', product.name);
                    const item = this.state.cart.find(i => i.id === product.id);
                    if (item) {
                        item.quantity++;
                        console.log('   Incremented quantity to:', item.quantity);
                    } else {
                        this.state.cart.push({ ...product, quantity: 1 });
                        console.log('   Added new item to cart');
                    }
                    console.log('   Cart items:', this.state.cart.length);
                },
                removeFromCart(productId) {
                    console.log('üóëÔ∏è Removing from cart:', productId);
                    const idx = this.state.cart.findIndex(i => i.id === productId);
                    if (idx !== -1) {
                        this.state.cart.splice(idx, 1);
                        console.log('   Removed item at index:', idx);
                    }
                },
                updateQuantity(productId, qty) {
                    console.log('üìù Updating quantity:', productId, 'to', qty);
                    const item = this.state.cart.find(i => i.id === productId);
                    if (item) {
                        if (qty <= 0) {
                            console.log('   Quantity <= 0, removing item');
                            this.dispatch('removeFromCart', productId);
                        } else {
                            item.quantity = qty;
                            console.log('   Updated quantity to:', qty);
                        }
                    } else {
                        console.log('   ‚ö†Ô∏è Item not found in cart');
                    }
                },
                clearCart() {
                    console.log('üßπ Clearing cart');
                    this.state.cart = [];
                }
            },
            getters: {
                cartItemsCount: (s) => s.cart.reduce((t, i) => t + i.quantity, 0),
                cartTotal: (s) => s.cart.reduce((t, i) => t + (i.price * i.quantity), 0)
            }
        });

        console.log('‚úÖ Store initialized');

        // Global notification function
        window.showNotification = function (message, type = 'success') {
            console.log('üîî Notification:', message, type);
            const event = new CustomEvent('app-notification', { detail: { message, type } });
            window.dispatchEvent(event);
        };

        const ProductDetail = {
            data: () => ({ quantity: 1 }),
            computed: {
                productId() {
                    const id = this.$router.params().id;
                    console.log('üÜî Product ID:', id);
                    return id;
                },
                product() {
                    const p = this.$store.state.products.find(p => p.id === parseInt(this.productId));
                    console.log('üõçÔ∏è Product:', p ? p.name : 'NOT FOUND');
                    return p;
                }
            },
            methods: {
                addToCart() {
                    console.log('üõí Add to cart clicked');
                    if (this.product) {
                        for (let i = 0; i < this.quantity; i++) {
                            this.$store.dispatch('addToCart', this.product);
                        }
                        window.showNotification(`${this.product.name} ajout√© au panier (√ó${this.quantity})`);
                    } else {
                        console.error('‚ùå No product to add');
                    }
                },
                goBack() { window.location.hash = '#/products'; }
            },
            hooks: {
                mounted() {
                    console.log('‚úÖ ProductDetail mounted');
                }
            },
            template: `
                <div class="product-detail">
                    <button @click="goBack" class="back-btn">‚Üê Retour aux produits</button>
                    <div v-if="!product" class="not-found">
                        <h2>Produit non trouv√©</h2>
                        <button @click="goBack" class="btn btn-primary">Retour</button>
                    </div>
                    <div v-else class="detail-container">
                        <div class="detail-image">
                            <img :src="product.image" :alt="product.name">
                        </div>
                        <div class="detail-info">
                            <h1>{{product.name}}</h1>
                            <p class="detail-price">{{product.price.toFixed(2)}}‚Ç¨</p>
                            <p class="detail-description">{{product.description}}</p>
                            <div class="detail-quantity">
                                <label>Quantit√©:</label>
                                <div class="quantity-selector">
                                    <button @click="quantity = Math.max(1, quantity - 1)" class="qty-btn">-</button>
                                    <span>{{quantity}}</span>
                                    <button @click="quantity++" class="qty-btn">+</button>
                                </div>
                            </div>
                            <button @click="addToCart" class="btn btn-primary btn-large">Ajouter au panier</button>
                        </div>
                    </div>
                </div>
            `
        };

        const Cart = {
            computed: {
                cartItems() { return this.$store.state.cart; },
                total() { return this.$store.getters.cartTotal; },
                isEmpty() { return this.cartItems.length === 0; }
            },
            methods: {
                updateQuantity(id, qty) {
                    console.log('üî¢ Update quantity button clicked:', id, qty);
                    this.$store.dispatch('updateQuantity', id, qty);
                },
                removeItem(id) {
                    console.log('‚ùå Remove button clicked:', id);
                    this.$store.dispatch('removeFromCart', id);
                },
                goToCheckout() { window.location.hash = '#/checkout'; }
            },
            hooks: {
                mounted() {
                    console.log('‚úÖ Cart mounted with', this.cartItems.length, 'items');
                }
            },
            template: `
                <div class="cart-page">
                    <h1>Mon Panier</h1>
                    <div v-if="isEmpty" class="empty-cart">
                        <p>Votre panier est vide</p>
                        <router-link to="/products" class="btn btn-primary">Continuer mes achats</router-link>
                    </div>
                    <div v-else>
                        <div class="cart-items">
                            <div v-for="i in cartItems" :key="i.id" class="cart-item">
                                <img :src="i.image" :alt="i.name" class="cart-item-image">
                                <div class="cart-item-info">
                                    <h3>{{i.name}}</h3>
                                    <p>{{i.price.toFixed(2)}}‚Ç¨</p>
                                </div>
                                <div class="cart-item-quantity">
                                    <button @click="updateQuantity(i.id, i.quantity - 1)" class="qty-btn">-</button>
                                    <span>{{i.quantity}}</span>
                                    <button @click="updateQuantity(i.id, i.quantity + 1)" class="qty-btn">+</button>
                                </div>
                                <div class="cart-item-total">{{(i.price * i.quantity).toFixed(2)}}‚Ç¨</div>
                                <button @click="removeItem(i.id)" class="remove-btn">‚úï</button>
                            </div>
                        </div>
                        <div class="cart-summary">
                            <div class="summary-row">
                                <span>Total:</span>
                                <strong>{{total.toFixed(2)}}‚Ç¨</strong>
                            </div>
                            <button @click="goToCheckout" class="btn btn-primary btn-large">Proc√©der au paiement</button>
                        </div>
                    </div>
                </div>
            `
        };

        const router = new MelodiRouter({
            routes: [
                { path: '/product/:id', component: ProductDetail },
                { path: '/cart', component: Cart }
            ]
        });

        console.log('‚úÖ Router initialized');

        const app = createApp({
            data: () => ({ notification: null }),
            hooks: {
                mounted() {
                    console.log('‚úÖ App mounted');
                    // Listen for global notification events
                    window.addEventListener('app-notification', (e) => {
                        console.log('üì¨ Received notification event:', e.detail);
                        this.notification = e.detail;
                        setTimeout(() => {
                            console.log('‚è∞ Clearing notification');
                            this.notification = null;
                        }, 3000);
                    });
                }
            }
        });

        app.use(store);
        app.use(router);
        app.mount('#app');

        console.log('‚úÖ App initialization complete');
        console.log('üìä Navigate to #/product/1 or #/cart to test');
    </script>
</body>

</html>